<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/combine/npm/chart.js@2.9.3/dist/Chart.min.css,npm/tachyons@4.11.1" />
  <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.4.1,npm/moment@2.24.0,npm/chart.js@2.9.3,npm/chartjs-plugin-datalabels@0.7.0"></script>
  <script>
    var covidData;

    function populateDashboard(data) {
      if ('rows' in data) {
        var numRowsToGet = 4;
        var lastNumRows = data.rows.slice(1).slice(-1 * numRowsToGet);
        var currentIndex;

        for (var i = numRowsToGet - 1; i > 0; i--) {
          if ((lastNumRows[i] !== null) && (lastNumRows[i][0] !== null)) {
            currentIndex = i;
            break;
          }
        }

        if (currentIndex > 0) {
          var current = lastNumRows[currentIndex];
          var previous = lastNumRows[currentIndex-1];

          var currentTotal = current[1];
          var previousTotal = previous[1];
          var newCases = currentTotal - previousTotal;
          var percentChange = Number(Math.round(((newCases / previousTotal) * 100) + 'e' + 2) +'e-'+ 2);
          $('#total_cases').text(currentTotal);
          $('#new_cases').text(newCases);

          $('#percent_change').addClass((percentChange > 0) ? 'dark-red' : 'dark-green');
          $('#percent_change').html((percentChange > 0) ? "&#8599;&nbsp;" + percentChange : "&#8600;&nbsp;" + percentChange);

          $('#title_data_updated').text(current[0]);
        }
      }
    }

    function populateDailyCases(data, dailyCasesChart) {
      if ('rows' in data) {
        data.rows.slice(1).slice(-21).forEach(function (item, index) {
          if (item[0] !== null) {
            dailyCasesChart.data.labels.push(moment(item[0]).format('MM/DD/YY'));
            dailyCasesChart.data.datasets[0].data.push(item[2]);
            dailyCasesChart.data.datasets[1].data.push(item[3]);
            dailyCasesChart.data.datasets[2].data.push(item[4]);
            dailyCasesChart.data.datasets[3].data.push(item[5]);
            dailyCasesChart.data.datasets[4].data.push(item[1]);
            dailyCasesChart.update();
          }
        });
      }
    }

    function getCovidDataFromApi() {
      $.ajax({
        url: 'https://covid19-hawaii.herokuapp.com/hawaii_daily.sqlite?sql=select+Date%2C+%5BTotal+Cases%5D%2C+%5BTotal+Oahu+Res%5D%2C+%5BTotal+Maui+Res%5D%2C+%5BTotal+HIsland+Res%5D%2C+%5BTotal+Kauai+Res%5D%2C+%5BTotal+Hosp%5D%2C+%5BTotal+Deaths%5D%2C+%5BTotal+Released%5D%2C+%5BTotal+Tests%5D%2C+%5BNegative+Tests%5D%2C+%5BPositive+Tests%5D+from+hawaii_daily+order+by+rowid&_format=json',
        success: function(data) {
          covidData = data;
          populateDashboard(covidData);
          populateDailyCases(covidData, dailyCasesChart);
        }
      });
    }

    $(document).ready(function() {
      getCovidDataFromApi();
    });
  </script>
</head>
<body>
  <article class="pa3">
    <section class="tc">
      <article class="w-100 ba b--black-20 mw6-ns center">
        <h1 class="sans-serif f1">Hawaii</h1>
        <h3 class="dark-gray">Last Updated: <span class="red f4" id="title_data_updated"></h3>
        <div class="bt b--black-20 pa2">
          <h2 class="f2">Total Cases: <span id="total_cases"></span></h2>
          <h2 class="f2">New: <span id="new_cases"></span></h2>
          <h2 class="f2">% Change: <span id="percent_change"></span></h2>
        </div>
      </article>
    </section>
    <div class="flex items-center justify-center">
      <div class="w-100 mw9-s mw8-l">
        <p>
          <canvas id="daily_cases" height="200px"></canvas>
          <script>
            var dailyCasesCtx = document.getElementById('daily_cases').getContext('2d');
            var dailyCasesChart = new Chart(dailyCasesCtx, {
              plugins: [
                ChartDataLabels,
                {
                  afterUpdate: function(chart) {
                  for (var i = 0; i < chart.config.data.datasets.length; i++) {
                    var dataset = chart.config.data.datasets[i];
                    var offset = -40;
                    for (var j = 0; j < dataset._meta[0].data.length; j++) {
                        var model = dataset._meta[0].data[j]._model;
                        model.x += offset;
                        model.controlPointNextX += offset;
                        model.controlPointPreviousX += offset;
                    }
                  }}
                }
              ],
              type: 'bar',
              data: {
                labels: [],
                datasets: [
                {
                  data: [],
                  label: 'Oahu',
                  backgroundColor: '#5899DA'
                },
                {
                  data: [],
                  label: 'Maui/Molokai/Lanai',
                  backgroundColor: '#E8743B'
                },
                {
                  data: [],
                  label: 'Hawaii',
                  backgroundColor: '#19A979'
                },
                {
                  data: [],
                  label: 'Kauai',
                  backgroundColor: '#6C8893',
                },
                {
                  data: [],
                  label: 'Total',
                  type: 'line',
                  fill: false,
                  color: '#000'
                }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: true,
                showScale: false,
                title: {
                  display: true,
                  text: "Daily COVID-19 Cases",
                  fontSize: 32,
                  fontFamily:"'Helvetica Neue', 'Helvetica', 'Arial'",
                  fontColor: '#333',
                },
                legend: {
                  display: true,
                  labels: {
                    fontColor: '#000',
                    fontSize: 24
                  }
                },
                scales: {
                  yAxes: [{
                    stacked: true,
                    ticks: {
                      beginAtZero: false,
                    }
                  }],
                  xAxes: [{
                    stacked: true,
                    type: 'time',
                    time: {
                      unit: 'month'
                    },
                    barThickness: 'flex',
                  }]
                }
              }
            });
          </script>
        </p>
      </div>
    </div>
  </article>
</body>
</html>
